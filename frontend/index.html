<!DOCTYPE html>
<html>
    <head>
        <title>Epihack project for animal / house hold and back yard</title>
        <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map-canvas {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .marker-content {
            min-height: 300px;
            width: 300px;
        }
        .gm-style .gm-style-iw .marker-content span.label {
            font-weight: bold;
            width: 90px;
            display: inline-block;
            text-align: right;
            margin-right: 5px;
        }
        .gm-style .gm-style-iw .marker-content span.field-content {

        }
        
        .detail-box {
            position: absolute;
            bottom: 50px;
            right: 50px;
            background-color: #FFF;
            border: solid 2px #EEE;
            padding: 20px;
        }
        .detail-box ul {
            margin: 0px;
            padding: 0px;
            list-style: none;
        }
        .detail-color {
            margin-right: 15px;
            width: 15px;
            height: 15px;
            display: inline-block;
            border-radius: 50%;
        }
        </style>
        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript" src="js/jquery-2.0.2.min.js"></script>
        <script type="text/javascript" src="js/StyledMarker.js"></script>
        <script type="text/javascript" src="js/markerclusterer.js"></script>
        
        
        
        <script type="text/javascript" src="js/data.js"></script>
        
        <script type="text/javascript">
        
        // Map  =============================================
        
        $ = jQuery;
        
        var colorToHex = function (c) {
          var m = /rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/.exec(c);
          return m ? '#' + (1 << 24 | m[1] << 16 | m[2] << 8 | m[3]).toString(16).substr(1) : c;
        }
        
        // style builder funtion
        var buildStyle = function (radius, color) {
            
             return {
                height: radius,
                textColor: '#ffffff',
                textSize: 11,
                url: 'http://localhost/openhelp/webform/clusterer?radius=' + radius + '&color=' + color,
                width: radius
            };
            
        };
        var buildStyleList = function (color) {
            return [
                buildStyle(35, color),
                buildStyle(40, color),
                buildStyle(50, color),
            ];
        };
        
        var calLatLng = function (lat, lng, count, j) {
            
            var radius = 0.00005;
            
            var angle = 2*Math.PI* (j/count);
            dLat = radius*Math.cos(angle);
            dLng = radius*Math.sin(angle);
            
            return new google.maps.LatLng(lat+dLat, lng+dLng);
        }
        
        var capitaliseFirstLetter = function (string)
        {
            return string.toLowerCase().charAt(0).toUpperCase() + string.slice(1);
        }
        
        // defined color each type
        var colorAll = {
            'PET'   : '226,85,158',
            'BIRD'  : '200,180,50',
            'FARM'  : '210,100,74',
            'EXOTIC': '79,167,104',
            'HUMAN' : '42,174,185',
        }
                
        var types = Object.keys(colorAll)
        
        // create style
        stylesAll = {};
        $.each(colorAll, function (type, color) {
            stylesAll[type] = buildStyleList(color);
        });
        
        var mapLoadded = function () {
            var center = new google.maps.LatLng(13.768, 100.554);
            
            var options = {
                'scrollwheel': false,
                'zoom': 5,
                'center': center,
                'mapTypeId': google.maps.MapTypeId.ROADMAP
            };
            
            var bounds = new google.maps.LatLngBounds;
            var info_window = new google.maps.InfoWindow;

            var map = new google.maps.Map($('#map-canvas').get(0), options);
            
            $.getScript('js/StyledMarker.js', function () {
            
            
                // define empty variable for store matker and group by type
                markerCluster = {};
                markers = {};
            
                $.each(types, function (i, type) {
                    markerCluster[type] = [];
                    markers[type] = [];
                });
                        
                $.each(data, function (i, location) {
                
                    $.each(location['members'], function (j, member) {
                                           
                        // Loop on the count                     
                                        
                        var latLng = calLatLng(location.lat, location.lng, location['members'].length, j);
                        var color = colorToHex('rgb(' + colorAll[member['type']] + ')');
                                                
                        var marker = new google.maps.Marker({
                            'position': latLng,
                            //'icon': 'image/'+member['type']+'.png'
                            'icon': 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=â€¢|'+ color.substring(1) +'|000000'
                            
                        });
                        
                    
                        google.maps.event.addListener(marker, 'click', function() {
                            info_window.close();
                        
                            var item_contents = 
                        
                            '<div class="marker-content">'+ 
                                '<h3>Type</h3>' + capitaliseFirstLetter(member['type']) +
                                '<h3 class="label">Address</h3>' +
                                '<p><span class="label">Contact name</span> : <span class="field-content">' + location['address']['firstName'] + ' ' + location['address']['lastName'] + '</span></p>' +
                                '<p><span class="label">Email</span> : <span class="field-content">' + location['address']['email'] + '</span></p>' +
                                '<p><span class="label">Street</span> : <span class="field-content">' + location['address']['street'] + '</span></p>' +
                                '<p><span class="label">Post code</span> : <span class="field-content">' + location['address']['postCode'] + '</span></p>' +
                                '<p><span class="label">City</span> : <span class="field-content">' + location['address']['city'] + '</span></p>' +
                                '<p><span class="label">Phone</span> : <span class="field-content">' + location['address']['phone'] + '</span></p>';
                            
                            if (member['symptoms'].length) {
                                
                                item_contents += '<h3 class="label">Symptoms</h3>';
                                item_contents += '<ul>';
                                
                                $.each(member['symptoms'], function (i, symptom) {
                                    item_contents += '<li>';
                                    item_contents +=     '<p><span class="field-content symptom-name">' + symptom['type'] + '</span></p>';
                                    item_contents +=     '<p><span class="label">Number</span> : <span class="field-content symptom-count">'+ symptom['count'] + '</span></p>';
                                    item_contents +=     '<p><span class="label">Danger level</span> : <span class="field-content symptom-danger-level">'+ symptom['dangerLevel'] + '</span></p>';
                                    item_contents +=     '<p><span class="label">Link</span> : <span class="field-content symptom-link"><a href="' + symptom['link']+'">'+ symptom['link'] + '</a></span></p>';
                                    item_contents += '</li>';
                                    
                                });
                                
                                item_contents += '</ul>';
                                
                            }
                                
                                '<h3 class="label">Symptoms</h3>';
                                
                                
                                
                            item_contents += '</div>';
                        
                            info_window.setContent(item_contents);
                            info_window.open(map, marker);
                        });
                    
                        markers[member['type']].push(marker);
            
                        bounds.extend(latLng);
                    
                    
                    });
                
                
                });
            
                $.each(types, function (i, type) {
                    markerCluster[type] = new MarkerClusterer(map, markers[type], {'styles': stylesAll[type]});
                });
            
                map.panTo(bounds.getCenter());
                map.fitBounds(bounds);
            });
        }
        
        
        $(document).ready(function () {
          mapLoadded();
          
          $.each(colorAll, function (type, color) {
              $('.detail-box-list').append($('<li><span class="detail-color" style="background-color:' + colorToHex('rgb(' + color + ')') +';"></span><span class="detail-text">' + capitaliseFirstLetter(type) + '</span></li>'));

          });
          
        });
        </script>

    </head>
    <body>
        <div class="container">
            <div class="header">
                
            </div>
            <div class="content">
                <div id="map">
                    <div id="map-canvas">
                        [ Map here ]
                    </div>
                </div>
                <div class="detail-box">
                    <ul class="detail-box-list">
                    </ul>
                </div>
            </div>
        </div>
    </body>
</html>